---
layout:     post
title:      Git 代码回滚
subtitle:   回滚代码的正确姿势
date:       2017-02-16
author:     Carlo
header-img: img/post-bg-default.jpg
catalog: true
tags:
    - Git
    - Github
---
# 好友系统设计

## 数据库设计

### 好友关系表结构 分表根据uid取模分表，用户的所有好友都在同一个表内

```mysql
CREATE TABLE `friend_relation_0` (
  `id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `uid` int(11) NOT NULL COMMENT '用户uid',
  `friend_uid` int(11) NOT NULL COMMENT '好友uid',
  `apply_status` tinyint(4) NOT NULL DEFAULT '1' COMMENT '1:uid主动申请  2：好友主动申请',
  `relation_status` tinyint(4) NOT NULL DEFAULT '0' COMMENT '关系状态0=>申请中、1=>关系确立',
  `create_time` int(11) NOT NULL COMMENT '申请时间',
  `update_time` int(11) NOT NULL COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_uid_frienduid` (`uid`,`friend_uid`),
  KEY `idx_uid_frienduid_applystatus` (`uid`,`friend_uid`,`apply_status`)
) ENGINE=InnoDB AUTO_INCREMENT=17301 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='好友关系表';
```

### 好友申请表结构

```mysql
CREATE TABLE `friend` (
  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `uid_apply` bigint(20) unsigned NOT NULL COMMENT '主动发起用户ID',
  `uid_follow` bigint(20) unsigned NOT NULL COMMENT '被动用户ID',
  `relation_status` tinyint(8) NOT NULL DEFAULT '0' COMMENT '关系状态0=>申请中、1=>关系确立',
  `is_del` tinyint(1) NOT NULL DEFAULT '0' COMMENT '是否被删除',
  `create_time` int(11) unsigned NOT NULL DEFAULT '0' COMMENT '添加为好友时间',
  `update_time` int(11) unsigned NOT NULL DEFAULT '0' COMMENT '好友关系修改时间',
  PRIMARY KEY (`id`),
  KEY `uid_apply` (`uid_apply`),
  KEY `uid_follow` (`uid_follow`)
) ENGINE=InnoDB AUTO_INCREMENT=230357 DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT='关系表';
```

### 我喜欢的表结构 分表根据uid取模

```mysql
CREATE TABLE `my_like_00` (
  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `uid` bigint(20) unsigned NOT NULL COMMENT '用户ID',
  `to_uid` bigint(20) unsigned NOT NULL COMMENT '被点赞用户ID',
  `context` varchar(255) COLLATE utf8mb4_unicode_ci NOT NULL DEFAULT '' COMMENT '点赞文本',
  `hidden` tinyint(4) unsigned NOT NULL DEFAULT '0' COMMENT '是否隐藏, 1:隐藏,0:不隐藏',
  `create_time` int(11) unsigned NOT NULL DEFAULT '0',
  `update_time` int(11) unsigned NOT NULL DEFAULT '0',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uid_to_uid` (`uid`,`to_uid`),
  KEY `user_hidden` (`uid`,`hidden`)
) ENGINE=InnoDB AUTO_INCREMENT=20666 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='我点赞的记录表';
```

### 喜欢我的表结构 分表根据uid取模

```mysql
CREATE TABLE `like_me_00` (
  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `uid` bigint(20) unsigned NOT NULL COMMENT '用户ID',
  `to_uid` bigint(20) unsigned NOT NULL COMMENT '被点赞用户ID',
  `context` varchar(255) COLLATE utf8mb4_unicode_ci NOT NULL DEFAULT '' COMMENT '点赞文本',
  `hidden` tinyint(4) unsigned NOT NULL DEFAULT '0' COMMENT '是否隐藏, 1:隐藏,0:不隐藏',
  `create_time` int(11) unsigned NOT NULL DEFAULT '0',
  `update_time` int(11) unsigned NOT NULL DEFAULT '0',
  PRIMARY KEY (`id`),
  UNIQUE KEY `to_uid_uid` (`to_uid`,`uid`),
  KEY `user_hidden` (`to_uid`,`hidden`)
) ENGINE=InnoDB AUTO_INCREMENT=20588 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='点赞我的记录表';
```

### 我关注的表结构 分表根据uid取模

```mysql
CREATE TABLE `user_follow_0` (
  `id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `uid` int(11) NOT NULL COMMENT 'uid',
  `to_uid` int(11) NOT NULL COMMENT '被关注uid',
  `friend_status` tinyint(4) NOT NULL COMMENT '好友状态 0:非好友  1：好友',
  `ctime` bigint(20) NOT NULL COMMENT '关注时间',
  `utime` bigint(20) NOT NULL COMMENT '好友时间，取消好友时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `unique_uid_toUid` (`uid`,`to_uid`),
  KEY `idx_uid_ctime` (`uid`,`ctime`),
  KEY `idx_uid_friendStatus_utime` (`uid`,`friend_status`,`utime`)
) ENGINE=InnoDB AUTO_INCREMENT=9273 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='关注关系';
```

### 我的粉丝（关注我的）表结构 分表根据uid取模

```mysql
CREATE TABLE `user_fans_0` (
  `id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `uid` int(11) NOT NULL COMMENT 'uid',
  `to_uid` int(11) NOT NULL COMMENT '粉丝uid',
  `friend_status` tinyint(4) NOT NULL COMMENT '好友状态 0:非好友  1：好友',
  `shield_status` tinyint(4) unsigned NOT NULL DEFAULT '0' COMMENT '屏蔽状态 0正常 1已重置 2 已注销 ',
  `ctime` bigint(20) NOT NULL COMMENT '粉丝时间',
  `utime` bigint(20) NOT NULL COMMENT '好友时间，取消好友时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `unique_uid_toUid` (`uid`,`to_uid`),
  KEY `idx_uid_ctime` (`uid`,`ctime`),
  KEY `idx_uid_friendStatus_utime` (`uid`,`friend_status`,`utime`)
) ENGINE=InnoDB AUTO_INCREMENT=9203 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='粉丝关系';
```



## 流程图

申请好友流程图



同意好友流程图

```mermaid
graph TB
    开始((点击同意))-->校验是否处于申请列表{校验是否处于申请列表}
    校验是否处于申请列表--不存在-->
    返回错误((返回错误))
    校验是否处于申请列表--存在-->
    添加好友-->
    开启事务-->
    更新申请表[更新friend表relation_status=1-update_time=当前时间]-->
    插入或更新双方关系表[插入或更新双方的friend_relation_uid%64表relation_status=1-update_time=当前时间]-->
    提交事物-->
    检查添加好友结果{检查添加好友结果}--错误-->返回错误
    检查添加好友结果--正常-->返回正常结果--异步运行-->
    投递kafka-->删除双方申请记录缓存-->删除双方我的好友缓存-->删除双方双向好友缓存-->删除双方点赞关系-->完成((完成))
```

### 接口与方法与表关系图

好友申请表与接口关系图

```mermaid
graph LR
好友关系表[(好友关系表)]
好友申请表[(好友申请表)]

同意添加好友数据库方法[[同意添加好友数据库方法-AgreeFriend]]
软删除好友关系数据库方法[[软删除好友关系数据库方法-UnFriend]]
直接添加好友数据库方法[[直接添加好友数据库方法-AddFriendDirect]]
获取我的全部好友数据库方法[[获取我的全部好友数据库方法-GetAllFriend]]
获取申请我为好友的人数据库方法[[获取申请我为好友的人数据库方法-GetApplyMeFriend]]
获取我的好友列表数据库方法[[获取我的好友列表数据库方法-GetFriendList]]
获取我的申请数据库方法[[获取我的申请数据库方法-GetMyApplyFriend]]
获取我的好友数据库方法[[获取我的好友数据库方法-GetMyFriend]]

获取我的好友总数缓存方法[[获取我的好友总数缓存方法-CacheGetMyFriendCount]]
获取我的好友Map缓存方法[[获取我的好友Map缓存方法-CacheGetMyFriendMap]]
获取我的好友缓存方法[[获取我的好友缓存方法-CacheGetMyFriendUid]]
获取我的申请列表Map缓存方法[[获取我的申请列表Map缓存方法-CacheGetMyApplyFriendMap]]
获取我的申请列表缓存方法[[获取我的申请列表缓存方法-CacheGetMyApplyFriendUid]]
获取申请我的列表缓存方法[[获取申请我的列表缓存方法-CacheGetApplyMeFriendUid]]
获取申请我的列表Map缓存方法[[获取申请我的列表Map缓存方法-CacheGetApplyMeFriendMap]]
获取我的新申请人数缓存方法[[获取我的新申请人数缓存方法-CacheGetApplyMeNum]]
获取我的全部好友缓存方法[[获取我的全部好友缓存方法-CacheFriendUidAllList]]

同意添加好友业务方法[[同意添加好友业务方法-AgreeFriend]]
批量同意添加好友业务方法[[批量同意添加好友业务方法-BatchAgree]]
软删除好友关系业务方法[[软删除好友关系业务方法-NewUnFriend]]
直接添加好友业务方法[[直接添加好友业务方法-AddFriendDirect]]
获取我的全部好友业务方法[[获取我的全部好友业务方法-GetFriendList]]
获取新的被申请数量业务方法[[获取新的被申请数量业务方法-ApplyMeNum]]
批量点赞用户业务方法[[批量点赞用户业务方法-BatchLike]]
点赞用户业务方法[[点赞用户业务方法-Like]]
是否显示点赞按钮业务方法[[是否显示点赞按钮业务方法-IsShowLike]]
获取我的好友列表业务方法[[获取我的好友列表业务方法-NewFriendListHand]]
批量判断是否存在关系业务方法[[批量判断是否存在关系业务方法-NewIsFriends]]
批量查询关系级别业务方法[[批量查询关系级别业务方法-RelationLevel]]
获取我的所有密友业务方法[[获取我的所有密友业务方法-GetFriendFollow]]

同意添加好友接口方法[[批量同意添加好友接口方法-/user/relation/agree_friend]]
批量同意添加好友接口方法[[批量同意添加好友接口方法-/user/relation/batch_agree]]
软删除好友关系接口方法[[软删除好友关系接口方法-/user/relation/unfriend]]
直接添加好友接口方法[[软删除好友关系接口方法-/user/relation/friend_direct]]
获取我的全部好友接口方法[[获取我的全部好友接口方法-/user/relation/get_friend_list]]
获取新的被申请数量接口方法[[获取新的被申请数量接口方法-/user/relation/apply_me_num]]
批量点赞用户接口方法[[批量点赞用户接口方法-/user/relation/batch_like]]
点赞用户接口方法[[点赞用户接口方法-/user/relation/like]]
是否显示点赞按钮接口方法[[是否显示点赞按钮接口方法-/user/relation/is_show_like]]
获取我的好友列表接口方法[[获取我的好友列表接口方法-/user/relation/friend_list]]
批量判断是否存在关系接口方法[[批量判断是否存在关系接口方法-/user/relation/is_friends]]
批量查询关系级别接口方法[[批量查询关系级别接口方法-/user/relation/relation_level]]
获取我的所有密友接口方法[[获取我的所有密友接口方法-/user/relation/get_friend_follow]]
根据时间获取新好友数量接口方法[[根据时间获取新好友数量接口方法-/user/relation/get_new_friend]]


好友关系表-->同意添加好友数据库方法-->批量同意添加好友业务方法-->批量同意添加好友接口方法
好友申请表-->同意添加好友数据库方法-->同意添加好友业务方法-->同意添加好友接口方法
好友关系表-->直接添加好友数据库方法
好友申请表-->直接添加好友数据库方法-->直接添加好友业务方法-->直接添加好友接口方法
好友关系表-->软删除好友关系数据库方法
好友申请表-->软删除好友关系数据库方法-->软删除好友关系业务方法-->软删除好友关系接口方法
好友申请表-->获取我的全部好友数据库方法-->获取我的全部好友缓存方法-->获取我的全部好友业务方法-->获取我的全部好友接口方法
好友申请表-->
获取申请我为好友的人数据库方法-->获取申请我的列表缓存方法-->获取我的全部好友业务方法
获取申请我为好友的人数据库方法-->获取我的新申请人数缓存方法-->获取新的被申请数量业务方法-->获取新的被申请数量接口方法
获取申请我为好友的人数据库方法-->
获取申请我的列表Map缓存方法-->同意添加好友业务方法
获取申请我的列表Map缓存方法-->批量同意添加好友业务方法
获取申请我的列表Map缓存方法-->是否显示点赞按钮业务方法-->是否显示点赞按钮接口方法
获取申请我的列表Map缓存方法-->点赞用户业务方法-->点赞用户接口方法
获取申请我的列表Map缓存方法-->批量点赞用户业务方法-->批量点赞用户接口方法
好友申请表-->获取我的好友列表数据库方法-->获取我的好友列表业务方法-->获取我的好友列表接口方法
好友申请表-->获取我的申请数据库方法-->获取我的申请列表缓存方法-->获取我的全部好友业务方法
获取我的申请数据库方法-->获取我的申请列表Map缓存方法-->批量判断是否存在关系业务方法-->批量判断是否存在关系接口方法
获取我的申请列表Map缓存方法-->是否显示点赞按钮业务方法
获取我的申请列表Map缓存方法-->点赞用户业务方法
获取我的申请列表Map缓存方法-->批量点赞用户业务方法
好友申请表-->
获取我的好友数据库方法-->获取我的好友总数缓存方法-->批量同意添加好友业务方法
获取我的好友数据库方法-->获取我的好友Map缓存方法-->批量判断是否存在关系业务方法
获取我的好友Map缓存方法-->软删除好友关系业务方法
获取我的好友Map缓存方法-->是否显示点赞按钮业务方法
获取我的好友Map缓存方法-->点赞用户业务方法
获取我的好友Map缓存方法-->批量点赞用户业务方法
获取我的好友Map缓存方法-->批量查询关系级别业务方法-->批量查询关系级别接口方法
获取我的好友数据库方法-->获取我的好友缓存方法-->根据时间获取新好友数量接口方法
获取我的好友缓存方法-->获取我的全部好友业务方法
获取我的好友缓存方法-->获取我的所有密友业务方法-->获取我的所有密友接口方法
```

我关注的表与接口关系图

```mermaid
graph LR
我关注的表[(我关注的表-user_follow)]
我的粉丝表[(我的粉丝表-user_fans)]

直接成为好友数据库方法[[直接成为好友数据库方法-DirectFriend]]
取消关注数据库方法[[取消关注数据库方法-DelUserFollow]]
新增关注数据库方法[[新增关注数据库方法-AddUserFollow]]

加关注粉丝集合缓存方法[[关注成功之后加关注/粉丝集合缓存方法-AddFollowRelation]]
获取关注数量缓存方法[[获取关注数量缓存方法-GetFollowRelationCnt]]
获取关注列表缓存方法[[获取关注列表缓存方法-GetFollowRelationList]]
设置用户新关注时间缓存方法[[设置用户新关注时间缓存方法-SetUserNewFollowRelationTime]]


获取关注列表业务方法[[获取关注列表业务方法-GetRelationList]]
获取关注关系数量业务方法[[获取关注关系数量业务方法-GetNewRelationCount]]
新增关注业务方法[[新增关注业务方法-Follow]]
取消关注业务方法[[取消关注业务方法-UnFollow]]
直接成为好友业务方法[[直接成为好友业务方法-DirectFriend]]
直接添加密友业务方法[[直接添加密友业务方法-AddFriendDirect]]

获取关注列表接口方法[[获取关注列表接口方法-/user/relation/follow/relation/list]]
获取关注关系数量接口方法[[获取关注关系数量接口方法-/user/relation/follow/relation/new_count]]
关注操作接口方法[[关注操作接口方法-/user/relation/follow/relation/operation]]
单身团关注数据导入接口方法[[单身团关注数据导入接口方法-/user/relation/follow/data/import]]
直接添加密友接口方法[[直接添加密友接口方法-/user/relation/friend_direct]]

设置用户新关注时间缓存方法-->获取关注列表业务方法
获取关注列表缓存方法-->获取关注列表业务方法
获取关注数量缓存方法-->获取关注列表业务方法-->获取关注列表接口方法
获取关注数量缓存方法-->获取关注关系数量业务方法-->获取关注关系数量接口方法

我的粉丝表-->新增关注数据库方法
我关注的表-->新增关注数据库方法-->新增关注业务方法-->单身团关注数据导入接口方法
加关注粉丝集合缓存方法-->新增关注业务方法-->关注操作接口方法
获取关注数量缓存方法-->新增关注业务方法

我的粉丝表-->取消关注数据库方法
我关注的表-->取消关注数据库方法-->取消关注业务方法-->关注操作接口方法

我的粉丝表-->直接成为好友数据库方法
我关注的表-->直接成为好友数据库方法-->直接成为好友业务方法-->直接添加密友业务方法-->直接添加密友接口方法
加关注粉丝集合缓存方法-->直接成为好友业务方法-->关注操作接口方法
```


